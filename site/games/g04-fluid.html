<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fluid Simulation</title>
  <style>
    :root {
      color-scheme: dark;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      --bg: #020617;
      --fg: #f1f5f9;
      --accent: #38bdf8;
      --panel: rgba(15, 23, 42, 0.85);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #01040f 100%);
      color: var(--fg);
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 16px;
      padding: 16px;
    }
    header {
      grid-column: 1 / -1;
      background: var(--panel);
      backdrop-filter: blur(18px);
      border: 1px solid rgba(148, 163, 184, 0.32);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    header h1 { margin: 0; font-size: 1.5rem; }
    .header-controls { display: flex; gap: 8px; }
    aside {
      background: var(--panel);
      border: 1px solid rgba(148, 163, 184, 0.28);
      border-radius: 16px;
      padding: 20px;
      display: grid;
      gap: 20px;
      align-content: start;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    aside h2 {
      margin: 0;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.85;
    }
    label {
      font-size: 0.85rem;
      display: grid;
      gap: 6px;
    }
    .control-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .control-value {
      font-weight: 700;
      color: var(--accent);
    }
    input[type="range"], select, button {
      appearance: none;
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 8px;
      padding: 8px 10px;
      color: inherit;
      font: inherit;
      transition: all 150ms ease;
    }
    button {
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.45);
      font-weight: 600;
      cursor: pointer;
    }
    button:hover:not(:disabled) {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.35);
    }
    main {
      background: var(--panel);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      min-height: 0;
    }
    #canvas {
      width: 100%;
      height: 100%;
      max-width: 900px;
      max-height: 100%;
      background: #000;
      border-radius: 12px;
      cursor: crosshair;
      display: block;
    }
    .color-swatch-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
    }
    .color-swatch {
      aspect-ratio: 1;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 150ms ease;
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3);
    }
    footer {
      grid-column: 1 / -1;
      background: rgba(15, 23, 42, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 0.85rem;
      text-align: center;
      opacity: 0.7;
    }
    @media (max-width: 1024px) {
      body { grid-template-columns: 1fr; }
      aside { max-height: none; }
    }
  </style>
</head>
<body>
  <header>
    <div><h1>Fluid Simulation</h1></div>
    <div class="header-controls">
      <button onclick="window.close(); window.location.href='/';" style="background: rgba(148, 163, 184, 0.15); border-color: rgba(148, 163, 184, 0.45);">← Back to Arcade</button>
      <button id="btn-clear">Clear</button>
      <button id="btn-pause">⏸ Pause</button>
    </div>
  </header>

  <aside>
    <section>
      <h2>Fluid Properties</h2>
      <label>
        <div class="control-header">
          <span>Viscosity</span>
          <span class="control-value" id="viscosity-val">20</span>
        </div>
        <input type="range" id="viscosity" min="0" max="100" value="20">
      </label>
      <label>
        <div class="control-header">
          <span>Velocity Decay</span>
          <span class="control-value" id="decay-val">0.99</span>
        </div>
        <input type="range" id="decay" min="0.9" max="0.99" step="0.01" value="0.99">
      </label>
    </section>

    <section>
      <h2>Particles</h2>
      <label>
        <div class="control-header">
          <span>Count</span>
          <span class="control-value" id="count-val">5000</span>
        </div>
        <input type="range" id="count" min="1000" max="15000" step="500" value="5000">
      </label>
      <label>
        <div class="control-header">
          <span>Size</span>
          <span class="control-value" id="size-val">2</span>
        </div>
        <input type="range" id="size" min="1" max="5" step="0.5" value="2">
      </label>
      <label>
        <div class="control-header">
          <span>Fade Speed</span>
          <span class="control-value" id="fade-val">0.995</span>
        </div>
        <input type="range" id="fade" min="0.9" max="0.999" step="0.001" value="0.995">
      </label>
    </section>

    <section>
      <h2>Interaction</h2>
      <label>
        <div class="control-header">
          <span>Force</span>
          <span class="control-value" id="force-val">30</span>
        </div>
        <input type="range" id="force" min="10" max="100" step="5" value="30">
      </label>
      <label>
        <div class="control-header">
          <span>Radius</span>
          <span class="control-value" id="radius-val">60</span>
        </div>
        <input type="range" id="radius" min="20" max="150" step="10" value="60">
      </label>
    </section>

    <section>
      <h2>Colors</h2>
      <div class="color-swatch-grid" id="palette"></div>
    </section>
  </aside>

  <main>
    <canvas id="canvas"></canvas>
  </main>

  <footer>
    Click and drag to create fluid motion • Watch colors swirl and blend
  </footer>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { alpha: false });

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      const width = Math.max(rect.width, 400);
      const height = Math.max(rect.height, 300);
      canvas.width = width;
      canvas.height = height;
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      if (particles.length === 0) {
        initParticles();
      }
    }
    
    // Delay initial resize to ensure DOM is fully laid out
    setTimeout(resizeCanvas, 100);
    window.addEventListener('resize', resizeCanvas);

    const config = {
      viscosity: 20,
      decay: 0.99,
      particleCount: 5000,
      particleSize: 2,
      fade: 0.995,
      force: 30,
      radius: 60,
      paused: false
    };

    const colors = [
      { r: 56, g: 189, b: 248 },
      { r: 139, g: 92, b: 246 },
      { r: 236, g: 72, b: 153 },
      { r: 239, g: 68, b: 68 },
      { r: 251, g: 191, b: 36 },
      { r: 16, g: 185, b: 129 }
    ];
    let currentColor = colors[0];

    class Particle {
      constructor(x, y, color) {
        this.x = x;
        this.y = y;
        this.vx = 0;
        this.vy = 0;
        this.color = color;
        this.life = 1;
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vx *= config.decay;
        this.vy *= config.decay;
        this.life *= config.fade;

        if (this.x < 0 || this.x > canvas.width) this.vx *= -0.8;
        if (this.y < 0 || this.y > canvas.height) this.vy *= -0.8;
        this.x = Math.max(0, Math.min(canvas.width, this.x));
        this.y = Math.max(0, Math.min(canvas.height, this.y));
      }

      draw() {
        ctx.fillStyle = `rgba(${this.color.r},${this.color.g},${this.color.b},${Math.min(this.life, 1)})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, config.particleSize, 0, Math.PI * 2);
        ctx.fill();
      }

      applyForce(fx, fy, dist, radius) {
        if (dist < radius) {
          const falloff = 1 - dist / radius;
          this.vx += fx * falloff * config.force * 0.01;
          this.vy += fy * falloff * config.force * 0.01;
        }
      }
    }

    let particles = [];
    let mouse = { x: 0, y: 0, prevX: 0, prevY: 0, down: false };

    function initParticles() {
      particles = [];
      for (let i = 0; i < config.particleCount; i++) {
        const p = new Particle(
          Math.random() * canvas.width,
          Math.random() * canvas.height,
          colors[Math.floor(Math.random() * colors.length)]
        );
        // Give initial random velocity for visual interest
        p.vx = (Math.random() - 0.5) * 2;
        p.vy = (Math.random() - 0.5) * 2;
        particles.push(p);
      }
    }

    function handleMouse(e, isTouch = false) {
      const rect = canvas.getBoundingClientRect();
      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;
      
      mouse.prevX = mouse.x;
      mouse.prevY = mouse.y;
      mouse.x = clientX - rect.left;
      mouse.y = clientY - rect.top;
    }

    canvas.addEventListener('mousedown', (e) => {
      handleMouse(e);
      mouse.down = true;
    });
    canvas.addEventListener('mousemove', (e) => {
      handleMouse(e);
      if (mouse.down) applyInteraction();
    });
    canvas.addEventListener('mouseup', () => mouse.down = false);
    canvas.addEventListener('mouseleave', () => mouse.down = false);

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      handleMouse(e, true);
      mouse.down = true;
    });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      handleMouse(e, true);
      applyInteraction();
    });
    canvas.addEventListener('touchend', () => mouse.down = false);

    function applyInteraction() {
      const dx = mouse.x - mouse.prevX;
      const dy = mouse.y - mouse.prevY;
      const injectCount = 8;

      for (let i = 0; i < injectCount; i++) {
        particles.push(new Particle(mouse.x, mouse.y, currentColor));
      }

      while (particles.length > config.particleCount) {
        particles.shift();
      }

      particles.forEach(p => {
        const pdx = mouse.x - p.x;
        const pdy = mouse.y - p.y;
        const dist = Math.sqrt(pdx * pdx + pdy * pdy);
        p.applyForce(dx, dy, dist, config.radius);
      });
    }

    function animate() {
      if (!config.paused) {
        // Slower fade for longer trails
        ctx.fillStyle = 'rgba(0, 0, 0, 0.02)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
          p.update();
          p.draw();
        });
      }
      requestAnimationFrame(animate);
    }

    function renderPalette() {
      const paletteEl = document.getElementById('palette');
      paletteEl.innerHTML = '';
      colors.forEach((color, i) => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = `rgb(${color.r},${color.g},${color.b})`;
        if (color === currentColor) swatch.classList.add('active');
        swatch.onclick = () => {
          currentColor = color;
          renderPalette();
        };
        paletteEl.appendChild(swatch);
      });
    }

    function setupControls() {
      ['viscosity', 'decay', 'count', 'size', 'fade', 'force', 'radius'].forEach(id => {
        const el = document.getElementById(id);
        el.oninput = (e) => {
          config[id] = id === 'count' ? parseInt(e.target.value) : parseFloat(e.target.value);
          document.getElementById(id + '-val').textContent = e.target.value;
          if (id === 'count') initParticles();
        };
      });

      document.getElementById('btn-clear').onclick = () => {
        ctx.fillStyle = '#000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        initParticles();
      };

      document.getElementById('btn-pause').onclick = (e) => {
        config.paused = !config.paused;
        e.target.textContent = config.paused ? '▶ Play' : '⏸ Pause';
      };
    }

    initParticles();
    renderPalette();
    setupControls();
    animate();
  </script>
</body>
</html>